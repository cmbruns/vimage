<?xml version="1.0" encoding="UTF-8"?>
<CPackWiXPatch>
  <CPackWiXFragment Id="#PRODUCT">

    <!-- Add to checkbox to launch program after install -->
    <UI>
        <UIRef Id="$(var.CPACK_WIX_UI_REF)" />
        <Publish Dialog="ExitDialog"
            Control="Finish"
            Event="DoAction"
            Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
    </UI>
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch vimage" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1"/>
    <Property Id="WixShellExecTarget" Value="[#CM_FP_vimage.exe]" />
    <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes"/>

    <!-- Jpeg open support component -->
    <Component Id="JpegOpenAssociation" Directory="INSTALL_ROOT" Guid="22490909-4583-4ff7-8bc4-3b79697daab3">
      <CreateFolder />
      <ProgId Id="jpgType" Description="*.jpg images">
        <Extension Id='jpg' ContentType="image/jpeg">
          <Verb Id='open' Command='Open' TargetProperty="FileAssociationProperty" Argument='"%1"' />
          <MIME ContentType="image/jpeg" Default="yes" />
          <MIME ContentType="image/pjpeg" Default="no" />
          <MIME ContentType="image/jpg" Default="no" />
        </Extension>
      </ProgId>
    </Component>

    <Component Id="JpegDefaultAssociation" Directory="INSTALL_ROOT" Guid="fdca15ce-f870-4063-a271-367c508a0231">
      <CreateFolder />
    </Component>

    <!-- Trick to avoid error ICE69 when using TargetFile attribute in file associations -->
    <SetProperty Id="FileAssociationProperty" Value="[INSTALL_ROOT]vimage.exe" After="CostFinalize" />

  </CPackWiXFragment>

  <CPackWiXFragment Id="#PRODUCTFEATURE">
    <!-- Always allow "Open with vimage" -->
    <ComponentRef Id="JpegOpenAssociation" />

    <!-- Toggleable features for default image file type associations -->
    <Feature Id="FiletypesFeature"
             Title="Default File Type Associations"
             Description="Always use vimage to open these image file types"
             Display="expand" AllowAdvertise="no"
             InstallDefault="local">
      <Feature Id="JpegTypesFeature"
               Title="*.jpg and *.jpeg files"
               Description="Always use vimage to open JPEG images"
               AllowAdvertise="no"
               InstallDefault="local">
        <ComponentRef Id="JpegDefaultAssociation" />
      </Feature>
    </Feature>

  </CPackWiXFragment>
</CPackWiXPatch>
