<?xml version="1.0" encoding="UTF-8"?>

<?include "cpack_variables.wxi"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" @CPACK_WIX_CUSTOM_XMLNS_EXPANDED@
    RequiredVersion="3.6.3303.0">

    <Product Id="$(var.CPACK_WIX_PRODUCT_GUID)"
        Name="$(var.CPACK_PACKAGE_NAME)"
        Language="1033"
        Version="$(var.CPACK_PACKAGE_VERSION)"
        Manufacturer="$(var.CPACK_PACKAGE_VENDOR)"
        UpgradeCode="$(var.CPACK_WIX_UPGRADE_GUID)">

        <Package InstallerVersion="301" Compressed="yes"/>

        <Media Id="1" Cabinet="media1.cab" EmbedCab="yes"/>

        <MajorUpgrade
            Schedule="afterInstallInitialize"
            AllowSameVersionUpgrades="yes"
            DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit."/>

        <WixVariable Id="WixUILicenseRtf" Value="$(var.CPACK_WIX_LICENSE_RTF)"/>
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALL_ROOT"/>

        <?ifdef CPACK_WIX_PRODUCT_ICON?>
        <Property Id="ARPPRODUCTICON">ProductIcon.ico</Property>
        <Icon Id="ProductIcon.ico" SourceFile="$(var.CPACK_WIX_PRODUCT_ICON)"/>
        <?endif?>

        <?ifdef CPACK_WIX_UI_BANNER?>
        <WixVariable Id="WixUIBannerBmp" Value="$(var.CPACK_WIX_UI_BANNER)"/>
        <?endif?>

        <?ifdef CPACK_WIX_UI_DIALOG?>
        <WixVariable Id="WixUIDialogBmp" Value="$(var.CPACK_WIX_UI_DIALOG)"/>
        <?endif?>

        <FeatureRef Id="ProductFeature"/>

        <UIRef Id="$(var.CPACK_WIX_UI_REF)" />

        <!-- Add to checkbox to launch program after install -->
        <UI>
            <UIRef Id="$(var.CPACK_WIX_UI_REF)" />
            <Publish Dialog="ExitDialog"
                Control="Finish"
                Event="DoAction"
                Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
        </UI>
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch vimage" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1"/>
        <Property Id="WixShellExecTarget" Value="[#CM_FP_vimage.exe]" />
        <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes"/>

        <?include "properties.wxi"?>
        <?include "product_fragment.wxi"?>

        <SetProperty Id='ExecutableTargetProperty' Value="[INSTALL_ROOT]vimage.exe" After="CostFinalize"/>
        <Feature Id="FiletypesFeature" Title="File Associations" Description="Open image files with vimage" Display="expand">
            <Feature Id="JpgTypesFeature" Title="*.jpg and *.jpeg" Description="Open JPEG images with vimage">
                <Component Id="JpegAssociation" Directory="INSTALL_ROOT" Guid="a7b1ce6f-2074-4301-a008-67952b07223b">
                    <CreateFolder />
                    <ProgId Id="JpegFileType" Description="JPEG images">
                        <Extension Id="jpg" ContentType="image/jpeg">
                            <Verb Id="open" TargetProperty="ExecutableTargetProperty" Command="Open" Argument="%1" />
                            <MIME ContentType="image/jpeg" Default="yes" />
                            <MIME ContentType="image/pjpeg" Default="yes" />  <!-- obsolete -->
                            <MIME ContentType="image/jpg" Default="yes" />  <!-- common misspelling -->
                        </Extension>
                    </ProgId>
                </Component>
            </Feature>
        </Feature>

    </Product>

</Wix>
